<div class="container tableGlobal">
  <div class="adminHeaderGlobal">
    <h1 class="titleAdmin">Lista de Usuarios</h1>

    <button mat-raised-button (click)="showAddUser = !showAddUser" class="buttonAddAdmin">
      {{ showAddUser ? 'Cancelar' : 'Añadir Usuario' }}
    </button>
  </div>

  <!-- Solo muestra la tabla si el usuario tiene rol de administrador -->
  <div *ngIf="isAdmin; else noAccess">

    <!-- Formulario para que podamos añadir usuarios -->
    <form *ngIf="showAddUser" [formGroup]="form" (ngSubmit)="addUser()" class="add-user-form" style="margin-bottom: 2rem; max-width: 400px;">
      <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="name" />
        <mat-error *ngIf="form.controls['name'].hasError('required')">El nombre es obligatorio</mat-error>
        <mat-error *ngIf="form.controls['name'].hasError('minlength')">Mínimo 4 caracteres</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" />
        <mat-error *ngIf="form.controls['email'].hasError('required')">El email es obligatorio</mat-error>
        <mat-error *ngIf="form.controls['email'].hasError('email')">Email no válido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
        <mat-label>Contraseña</mat-label>
        <input matInput type="password" formControlName="password" />
        <mat-error *ngIf="form.controls['password'].hasError('required')">La contraseña es obligatoria</mat-error>
        <mat-error *ngIf="form.controls['password'].hasError('minlength')">Mínimo 6 caracteres</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
        <mat-label>Rol</mat-label>
        <mat-select formControlName="role">
          <mat-option *ngFor="let role of roles" [value]="role">{{ role }}</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid" style="width: 100%;">
        Agregar Usuario
      </button>
    </form>

    <!-- Filtro para buscar usuario por nombre, email o rol -->
    <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 1rem;">
      <mat-label>Buscar usuario</mat-label>
      <input
        matInput
        (keyup)="applyFilter($event)"
        placeholder="Nombre, email o rol"
        aria-label="Buscar usuarios"
      />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Aquí tenemos la tabla de usuarios, solo acceso el administrador -->
    <div class="table-container mat-elevation-z8">
      <table mat-table [dataSource]="dataSource" class="full-width" matSort>
        <!-- Columnas de la tabla usuarios -->
        <ng-container matColumnDef="iduser">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
          <td mat-cell *matCellDef="let user">{{ user.iduser }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
          <td mat-cell *matCellDef="let user">{{ user.name }}</td>
        </ng-container>

        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
          <td mat-cell *matCellDef="let user">{{ user.email }}</td>
        </ng-container>

        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Rol</th>
          <td mat-cell *matCellDef="let user">{{ user.role }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let user">
            <button
              mat-icon-button
              color="warn"
              matTooltip="Eliminar"
              (click)="openDeleteModal(user.iduser)"
              aria-label="Eliminar usuario"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <mat-paginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons></mat-paginator>
    </div>
  </div>

  <!-- Si no eres administrador saldrá este mensaje, ya que solo admin pueden acceder -->
  <ng-template #noAccess>
    <p style="text-align:center; padding: 2rem; font-weight: bold;">
      No tienes permiso para ver esta sección.
    </p>
  </ng-template>

  <!-- Aquí tenemos un modal de bootstrap para eliminar usuarios -->
  <div
    class="modal fade"
    id="confirmDeleteModal"
    tabindex="-1"
    aria-labelledby="confirmDeleteModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar eliminación</h5>
          <button type="button" class="btn-close" (click)="closeModal()" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          ¿Estás seguro de que deseas eliminar este usuario?
        </div>
        <div class="modal-footer">
          <button mat-button (click)="closeModal()">Cancelar</button>
          <button mat-raised-button color="warn" (click)="confirmDelete()">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</div>
